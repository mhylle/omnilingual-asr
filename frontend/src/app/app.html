<div class="container">
  <header class="header">
    <h1>üéôÔ∏è {{ title() }}</h1>
    <p class="subtitle">Speech Recognition in 1,600+ Languages</p>
  </header>

  <main class="main-content">
    <!-- Recording Section -->
    <div class="recording-section">
      <div class="recorder-card">
        <!-- Audio Source Tabs -->
        <div class="source-tabs">
          <button
            class="source-tab"
            [class.active]="audioSource() === 'recording' || audioSource() === null"
            (click)="clearUpload()"
            [disabled]="isProcessing()">
            üé§ Record Audio
          </button>
          <button
            class="source-tab"
            [class.active]="audioSource() === 'upload'"
            (click)="switchToUpload()"
            [disabled]="isProcessing()">
            üìÅ Upload File
          </button>
        </div>

        <!-- Recording Mode -->
        @if (audioSource() !== 'upload') {
          <!-- Duration Display -->
          <div class="duration-display"
               [class.warning]="durationWarning()"
               [class.critical]="durationCritical()">
            <span class="duration-label">Duration:</span>
            <span class="duration-time">{{ formattedDuration() }}</span>
            @if (durationCritical()) {
              <span class="duration-alert">‚ö†Ô∏è Stop recording! (40s limit)</span>
            } @else if (durationWarning()) {
              <span class="duration-warning">Approaching 40s limit</span>
            }
          </div>

          <!-- Recording Controls -->
          <div class="controls">
            @if (!isRecording()) {
              <button
                class="btn btn-primary btn-large"
                (click)="startRecording()"
                [disabled]="isProcessing()">
                <span class="btn-icon">üé§</span>
                Start Recording
              </button>
            } @else {
              <div class="recording-controls">
                @if (!isPaused()) {
                  <button
                    class="btn btn-warning"
                    (click)="pauseRecording()">
                    <span class="btn-icon">‚è∏Ô∏è</span>
                    Pause
                  </button>
                } @else {
                  <button
                    class="btn btn-success"
                    (click)="resumeRecording()">
                    <span class="btn-icon">‚ñ∂Ô∏è</span>
                    Resume
                  </button>
                }

                <button
                  class="btn btn-danger"
                  (click)="stopRecording()">
                  <span class="btn-icon">‚èπÔ∏è</span>
                  Stop
                </button>
              </div>
            }
          </div>

          <!-- Recording Status -->
          @if (isRecording()) {
            <div class="recording-status">
              <span class="recording-indicator"></span>
              @if (isPaused()) {
                <span>Recording Paused</span>
              } @else {
                <span>Recording...</span>
              }
            </div>
          }

          <!-- Error Display -->
          @if (recordingError()) {
            <div class="alert alert-error">
              {{ recordingError() }}
            </div>
          }
        }

        <!-- Upload Mode -->
        @if (audioSource() === 'upload') {
          <div class="upload-section">
            <label for="audioFile" class="upload-label">
              <input
                type="file"
                id="audioFile"
                class="upload-input"
                accept="audio/*,.wav,.mp3,.flac,.ogg,.webm,.m4a"
                (change)="onFileSelected($event)"
                [disabled]="isProcessing()" />
              <div class="upload-box" [class.has-file]="uploadedFile()">
                @if (!uploadedFile()) {
                  <div class="upload-placeholder">
                    <span class="upload-icon">üìÅ</span>
                    <span class="upload-text">Click to upload audio file</span>
                    <span class="upload-hint">WAV, MP3, FLAC, OGG, WebM, M4A (Max 50MB)</span>
                  </div>
                } @else {
                  <div class="upload-file-info">
                    <span class="file-icon">üéµ</span>
                    <div class="file-details">
                      <span class="file-name">{{ uploadedFile()!.name }}</span>
                      <span class="file-size">{{ (uploadedFile()!.size / 1024 / 1024).toFixed(2) }} MB</span>
                    </div>
                    <button
                      class="btn-clear"
                      type="button"
                      (click)="clearUpload(); $event.stopPropagation()"
                      [disabled]="isProcessing()">
                      ‚úï
                    </button>
                  </div>
                }
              </div>
            </label>
          </div>
        }
      </div>

      <!-- Settings -->
      <div class="settings-card">
        <h3>Settings</h3>

        <div class="form-group">
          <label for="language">Language</label>
          <select
            id="language"
            class="form-select"
            [value]="selectedLanguage()"
            (change)="selectedLanguage.set($any($event.target).value)"
            [disabled]="isProcessing()">
            @for (lang of languages; track lang.code) {
              <option [value]="lang.code">{{ lang.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="model">Model</label>
          <select
            id="model"
            class="form-select"
            [value]="selectedModel()"
            (change)="selectedModel.set($any($event.target).value)"
            [disabled]="isProcessing()">
            @for (model of models; track model.code) {
              <option [value]="model.code">{{ model.name }}</option>
            }
          </select>
        </div>

        <div class="info-box">
          <p><strong>Note:</strong> You can either record audio (max 40 seconds) or upload an audio file (max 50MB). Supported formats: WAV, MP3, FLAC, OGG, WebM, M4A.</p>
        </div>
      </div>
    </div>

    <!-- Transcription Section -->
    <div class="transcription-section">
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button
          class="btn btn-primary"
          (click)="transcribe()"
          [disabled]="!canTranscribe() || isTranscribing()">
          @if (isTranscribing()) {
            <span class="spinner"></span>
            Transcribing...
          } @else {
            <span class="btn-icon">üìù</span>
            Transcribe
          }
        </button>

        @if (transcription()) {
          <button
            class="btn btn-secondary"
            (click)="copyTranscription()">
            <span class="btn-icon">üìã</span>
            Copy
          </button>
        }

        @if (canTranscribe() || transcription()) {
          <button
            class="btn btn-outline"
            (click)="reset()"
            [disabled]="isProcessing()">
            <span class="btn-icon">üîÑ</span>
            Reset
          </button>
        }
      </div>

      <!-- API Error -->
      @if (apiError()) {
        <div class="alert alert-error">
          <strong>Error:</strong> {{ apiError() }}
        </div>
      }

      <!-- Transcription Result -->
      @if (transcription()) {
        <div class="transcription-card">
          <h3>Transcription Result</h3>
          <div class="transcription-text">
            {{ transcription() }}
          </div>

          @if (lastMetadata()) {
            <div class="metadata-info">
              <h4 class="metadata-section-title">Settings Used</h4>
              <div class="metadata-grid">
                <div class="metadata-item">
                  <span class="metadata-label">ü§ñ Model:</span>
                  <span class="metadata-value">{{ lastMetadata().model }}</span>
                </div>
                @if (lastMetadata().language) {
                  <div class="metadata-item">
                    <span class="metadata-label">üåç Language:</span>
                    <span class="metadata-value">{{ lastMetadata().language }}</span>
                  </div>
                }
                <div class="metadata-item">
                  <span class="metadata-label">üìÅ Filename:</span>
                  <span class="metadata-value">{{ lastMetadata().filename }}</span>
                </div>
              </div>
            </div>
          }

          @if (lastTimings()) {
            <div class="timings-info">
              <h4 class="metadata-section-title">‚è±Ô∏è Performance Breakdown</h4>

              <div class="timings-section">
                <h5 class="timings-subtitle">Client-Side (Browser)</h5>
                <div class="timings-grid">
                  <div class="timing-item">
                    <span class="timing-label">üì§ Network Upload:</span>
                    <span class="timing-value">{{ lastTimings().network_upload }}</span>
                  </div>
                  <div class="timing-item timing-highlight">
                    <span class="timing-label">üåê Total Client Time:</span>
                    <span class="timing-value">{{ lastTimings().total_client }}</span>
                  </div>
                </div>
              </div>

              <div class="timings-section">
                <h5 class="timings-subtitle">Server-Side (Backend)</h5>
                <div class="timings-grid">
                  <div class="timing-item">
                    <span class="timing-label">üíæ Save Upload:</span>
                    <span class="timing-value">{{ lastTimings().upload_and_save }}</span>
                  </div>
                  <div class="timing-item">
                    <span class="timing-label">üéµ Audio Conversion:</span>
                    <span class="timing-value">{{ lastTimings().audio_conversion }}</span>
                  </div>
                  <div class="timing-item">
                    <span class="timing-label">üîß Model Loading:</span>
                    <span class="timing-value">{{ lastTimings().model_loading }}</span>
                    @if (lastTimings().model_was_cached) {
                      <span class="timing-badge">Cached ‚úì</span>
                    }
                  </div>
                  <div class="timing-item">
                    <span class="timing-label">üé§ Transcription:</span>
                    <span class="timing-value">{{ lastTimings().transcription }}</span>
                  </div>
                  <div class="timing-item timing-highlight">
                    <span class="timing-label">‚ö° Total Backend:</span>
                    <span class="timing-value">{{ lastTimings().total_backend }}</span>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      } @else if (!isTranscribing()) {
        <div class="placeholder-card">
          <p>üëÜ Record or upload audio, then click "Transcribe" to see the result here</p>
        </div>
      }
    </div>
  </main>

  <footer class="footer">
    <p>Powered by Meta's Omnilingual ASR ‚Ä¢ Supporting 1,600+ Languages</p>
  </footer>
</div>

<router-outlet />
